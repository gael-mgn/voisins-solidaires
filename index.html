<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Petites annonces ‚Äî Exemple</title>

  <script src="cookie.js"></script>

  <script src="https://gael-mgn.github.io/js/read-and-edit-row.js"></script>
  <script src="get-data.js"></script>

  <script src="loader.js"></script>


  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

    <!-- Leaflet CSS & JS (redondance volontaire / conserv√©e du prototype original) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --accent:#ff6b00;
      --muted:#6b7280;
      --shadow: 0 6px 18px rgba(20,20,30,0.06);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111}

    /* Header: maintenant en deux lignes */
    header{
      
/*      border-bottom:1px solid #e9e9ee;*/
      position:sticky;top:0;z-index:40;
      display:flex;flex-direction:column;
      box-shadow: 0 2px 6px rgba(15,15,20,0.02);
      z-index: 1000;
    }

    .header-top{display:flex;align-items:center;gap:16px;
    padding:12px 20px;background:linear-gradient(90deg,#ffffff, #fffaf5);}
    .header-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:10px;
      padding:12px;
      background-color: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(4px);
    }

    .brand{display:flex;align-items:center;gap:12px;font-weight:700}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#ff9b3c);display:inline-flex;align-items:center;justify-content:center;color:white;font-size:18px}
    .searchbar{flex:1;display:flex;gap:10px;align-items:center}
    input[type="search"]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e6e7ee;background:white;outline:none}
    select, button{padding:10px 12px;border-radius:10px;border:1px solid #e6e7ee;background:white}

    /* Auth controls */
    .auth-btn, .auth-link {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--accent);
      background:transparent;
      cursor:pointer;
      font-weight:600;
    }
    .auth-btn.primary {
      background:var(--accent);
      color:white;
      border-color: rgba(0,0,0,0.03);
      box-shadow: 0 6px 14px rgba(255,107,0,0.12);
    }
    .auth-btn.ghost {
      border:1px solid transparent;
      background:transparent;
      color:var(--accent);
    }
    .auth-link { color:#3D3D3D; text-decoration:none; padding:8px 10px; border-radius:8px; }
    .auth-link:hover, .auth-btn:hover { transform: translateY(-1px); }

    .wrap{max-width:1200px;margin:26px auto;padding:0 20px;display:grid;grid-template-columns:260px 1fr;gap:22px}

    .sidebar{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
    .filters h4{margin:0 0 10px 0;font-size:14px}
    .categories{display:flex;flex-direction:column;gap:8px}
    .cat{padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .cat:hover{background:#fffaf2;border-color:#ffe7cf}

    .main{display:flex;flex-direction:column;gap:16px}
    .tools{display:flex;gap:12px;align-items:center}
    .count{color:var(--muted);font-size:14px}

    .listings{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:transform .12s,box-shadow .12s}
    .card:hover{transform:translateY(-6px)}
    .card img{width:100%;height:160px;object-fit:cover;display:block}
    .card-body{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:600;font-size:15px}
    .meta{font-size:13px;color:var(--muted);display:flex;justify-content:space-between}
    .price{color:var(--accent);font-weight:700}

    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:#fff7f1;color:#b14800;border:1px solid #ffe7cf}

    footer{max-width:1200px;margin:22px auto;padding:22px;text-align:center;color:var(--muted)}

    /* Responsive */
    @media (max-width:880px){
      .wrap{grid-template-columns:1fr;}
      .sidebar{order:2}
      header{}
      .header-top{flex-direction:column;align-items:flex-start;gap:10px}
      .header-actions{justify-content:flex-start}
      .searchbar{width:100%}
    }

    /* ========== Loader overlay for the map ========== */
    .map-wrapper { position: relative; width: 100%; height: 100%; }
    .map-loader {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-direction: column;
      backdrop-filter: blur(2px);
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.55));
      z-index: 100; /* au-dessus de la carte */
      border-radius: 12px;
    }
    .map-loader.visible { display: flex; }

    .map-loader .spinner {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 5px solid rgba(0,0,0,0.08);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    .map-loader .text {
      font-size: 14px;
      color: #333;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* small accessible visually-hidden label for screenreaders */
    .sr-only{
      position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-size:16px">Voisins Solidaires</div>
          <div style="font-size:12px;color:var(--muted)">Partager la terre, tisser des liens</div>
        </div>
      </div>

      <div class="searchbar">
        <input id="q" type="search" placeholder="Que recherchez-vous ?" />
        <select id="categorySelect" aria-label="Cat√©gorie">
          <option value="">Toutes cat√©gories</option>
        </select>
        <button id="searchBtn">Rechercher</button>
      </div>
    </div>

    <!-- LIGNE D'ACTIONS (Se connecter / S'inscrire) ou (Mes annonces / Se d√©connecter) -->
    <div class="header-actions" id="authActions">
      <!-- contenu g√©n√©r√© par JS -->
    </div>
  </header>

<style>
  /* --- SECTION --- */
  .cta-section {
    position: relative;
    background-image: url('image.webp'); /* üåÖ Remplace par ton image */
    background-size: cover;
    background-position: center;
    color: #fff;
    text-align: center;
    padding: 80px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  /* --- OVERLAY SOMBRE --- */
  .cta-section::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.15);
    z-index: 1;
  }

  /* --- CONTENU --- */
  .cta-content {
    position: relative;
    z-index: 2;
    max-width: 600px;
  }

  /* --- TITRE & TEXTE --- */
  .cta-content h2 {
    font-size: 2rem;
    margin-bottom: 15px;
  }

  .cta-content p {
    font-size: 1.1rem;
    margin-bottom: 30px;
    opacity: 0.9;
  }

  /* --- BOUTON CTA --- */
  .cta-button {
    display: inline-block;
    background-color: #fff;
    color: var(--accent);
    font-weight: bold;
    padding: 15px 30px;
    border-radius: 50px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .cta-button:hover {
    background-color: var(--accent);
    color: #fff;
    transform: scale(1.05);
  }

  /* --- RESPONSIVE --- */
  @media (max-width: 600px) {
    .cta-content h2 {
      font-size: 1.6rem;
    }

    .cta-button {
      padding: 12px 25px;
    }
  }

  .lien {
    color: inherit;
    font-weight: bold;
  }
</style>

<section class="cta-section">
  <div class="cta-content">
    <h2>Vous avez quelque chose √† partager ?</h2>
    <p>
      Publiez votre annonce gratuitement !<br>
      <a href="sign-in.html?redirect=edit.html" class="lien">Connectez-vous</a> ou
      <a href="sign-up.html" class="lien">inscrivez-vous</a> pour publier une annonce !
    </p>
    <a href="sign-up.html?redirect=edit.html" class="cta-button" id="publish">Publier une annonce</a>
  </div>
</section>


<!-- Section Carte + Projet -->
<section class="map-project">
  <!-- map wrapper: contient la carte Leaflet et l'overlay de chargement -->
  <div class="map-wrapper">
    <div id="map"></div>

    <!-- Overlay de chargement sp√©cifique √† la carte -->
    <div class="map-loader" id="mapLoader" role="status" aria-live="polite" aria-hidden="true">
      <div class="spinner" aria-hidden="true"></div>
      <div class="text" id="mapLoaderText">Chargement des annonces‚Ä¶</div>
      <span class="sr-only" id="mapLoaderSR">Chargement en cours</span>
    </div>
  </div>

  <div class="project-info">
    <h3>√Ä propos de Voisins Solidaires</h3>
    <p>
      La solidarit√© pousse dans nos quartiers.<br>
      Voisins Solidaires connecte ceux qui ont √† partager avec ceux qui en ont besoin :<br>
      fruits √† cueillir, jardins √† cultiver, coups de main, √©v√©nements citoyens‚Ä¶
    </p>
    <p>Ensemble, faisons grandir les liens qui nous rassemblent.</p>
  </div>
</section>

<style>
  #map,
#map * {
  z-index: 0 !important;
}
  .map-project {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 22px;
  }

  .map-project #map {
    width: 100%;
    height: 380px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .map-project .project-info {
    background: var(--card);
    padding: 18px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
  }

  .map-project .project-info h3 {
    margin: 0;
  }

  .map-project .project-info p {
    font-size: 14px;
    color: var(--muted);
  }

  /* ‚úÖ Responsive : carte au-dessus du texte */
  @media (max-width: 768px) {
    .map-project {
      grid-template-columns: 1fr;
    }

    .map-project #map {
      order: 1;
      height: 300px;
    }

    .map-project .project-info {
      order: 2;
      margin-top: 12px;
    }
  }
</style>


  <main class="wrap">
    <aside class="sidebar">
      <div class="filters">
        <h4>Cat√©gories</h4>
        <div class="categories" id="categoriesList"></div>
      </div>
      <hr style="margin:12px 0;border:none;border-top:1px solid #f0f0f5" />
    </aside>

    <section class="main">
      <div class="tools">
        <div class="count" id="count">-- annonces</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label for="sort">Trier</label>
          <select id="sort">
            <option value="new">Plus r√©centes</option>
          </select>
        </div>
      </div>

      <div class="listings" id="listings">
        <!-- cards injected here -->
      </div>

    </section>
  </main>

  <footer>
    Prototype d'interface d'annonces
  </footer>

  <script>
    // =====================================================
    // üîÅ Simulation de l'√©tat de connexion (variable bool√©enne)
    // =====================================================
    // changez la valeur initiale pour simuler l'√©tat (true = connect√©, false = d√©connect√©)
    let isLoggedIn = false;

    const authActionsEl = document.getElementById('authActions');

    function renderAuth() {
      if (!authActionsEl) return;
      if (!isLoggedIn) {
        document.getElementById("publish").href = "sign-up.html?redirect=edit.html";
        // utilisateur d√©connect√© : afficher Se connecter / S'inscrire
        authActionsEl.innerHTML = `
          <a class="auth-link" href="sign-in.html?redirect=index.html" id="linkSignIn">Se connecter</a>
          <a class="auth-btn primary" href="sign-up.html?redirect=index.html" id="linkSignUp">S'inscrire</a>
        `;
        const signIn = document.getElementById('linkSignIn');
        const signUp = document.getElementById('linkSignUp');
        signIn && signIn.addEventListener('click', (e) => {
         //e.preventDefault(); //isLoggedIn = true; renderAuth(); alert('Simul√© : connect√©');
       });
        signUp && signUp.addEventListener('click', (e) => { 
          //e.preventDefault(); isLoggedIn = true; renderAuth(); alert('Simul√© : inscrit et connect√©'); 
        });
      } else {
        document.getElementById("publish").href = "edit.html";
        // utilisateur connect√© : afficher Mes annonces / Se d√©connecter
        authActionsEl.innerHTML = `
          <a class="auth-btn ghost" href="edit.html" id="myAdsBtn">Mes annonces</a>
          <a class="auth-link" id="logoutBtn">Se d√©connecter</a>
        `;
        document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); 
          isLoggedIn = false; renderAuth();
          clearLoginCookie();
      });
        document.getElementById('myAdsBtn').addEventListener('click', (e) => { /* ici redirection r√©elle */ });
      }
    }

    // render initial auth
    renderAuth();
  </script>

  <script>
    // ---------- Fonctions pour le loader de la carte ----------
    function showMapLoader(text) {
      const el = document.getElementById('mapLoader');
      if (!el) return;
      const txt = document.getElementById('mapLoaderText');
      const sr = document.getElementById('mapLoaderSR');
      if (text) {
        txt.textContent = text;
        sr.textContent = text;
      }
      el.classList.add('visible');
      el.setAttribute('aria-hidden', 'false');
    }
    function hideMapLoader() {
      const el = document.getElementById('mapLoader');
      if (!el) return;
      el.classList.remove('visible');
      el.setAttribute('aria-hidden', 'true');
    }

    // ==========================================================
    // Connexion / Login (garde l'utilisation openPageLoader existante)
    // ==========================================================
    const spreadsheetId = "1sVCmgprkNQLroXlowU-Rp0PlUySAFZ331x3H5t3VT7A";

    async function Login() {

      console.log("V√©rification de la connexion");

      let cookie_user = "";
      let cookie_password = "";

      const localLogin = true;

      const loginInfo = getLoginCookie();
      if (loginInfo) {
        console.log("‚úÖ Cookie d√©tect√© :", loginInfo);
        cookie_user = loginInfo.email;
        cookie_password = loginInfo.code;
        openPageLoader("Connexion en cours...");
        user = await getRowById(spreadsheetId, "users", cookie_user);

        if(user["password"] != cookie_password){
          user = null;
          console.log("le mot de passe n'est plus √† jour dans le cookie !");
          clearLoginCookie(); // Supression du cookie
        }
      } else if (window.location.protocol === 'file:' && localLogin == true) {

        openPageLoader("Connexion en cours...");

        cookie_user = "gael.maignan@eivp-paris.fr";
        try {
          user = await getRowById(spreadsheetId, "users", cookie_user);
        }catch (error) {
          console.error("Erreur lors de la r√©cup√©ration :", error);
        } finally {
          closePageLoader();
          // üëâ Toujours ex√©cut√©, m√™me si erreur
        }
      }

      if(user){
        closePageLoader();
        console.log("Utilisateur:",user);
        isLoggedIn = true;
        renderAuth();
      }
    }

    Login();
// ==========================================================
// chargement() : r√©cup√®re annonces, initialise UI + carte
// √©cran de chargement sur la carte pendant le fetch
// ==========================================================
async function chargement() {
  // On affiche le loader sur la carte AVANT la requ√™te
  showMapLoader("Chargement des annonces‚Ä¶");

  let annonces = [];
  try {
    annonces = await fetchSheetData2();

    // Initialisation des cat√©gories
    const categories = Array.from(new Set(annonces.map(a=>a.category))).sort();
    const categoriesList = document.getElementById('categoriesList');
    const categorySelect = document.getElementById('categorySelect');

    // --- Ajout d'une option vide dans le <select> pour "Toutes"
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'Toutes les cat√©gories';
    categorySelect.appendChild(defaultOpt);

    // --- Fonction utilitaire pour (d√©)s√©lectionner une cat√©gorie et g√©rer l'√©tat actif des boutons
    function setCategoryValue(cat, btnElement = null) {
      categorySelect.value = cat;
      render();

      // gestion visuelle des boutons "actifs"
      const allBtns = categoriesList.querySelectorAll('.cat');
      allBtns.forEach(b => b.classList.remove('active'));
      if (btnElement) btnElement.classList.add('active');
      else {
        // si aucun bouton fourni (par ex. on a s√©lectionn√© via le <select>),
        // on marque le bouton correspondant si trouv√©, sinon aucun actif (toutes)
        const matching = categoriesList.querySelector(`.cat[data-cat="${cat}"]`);
        if (matching) matching.classList.add('active');
      }
    }

    // --- Bouton "Toutes les cat√©gories"
    const btnAll = document.createElement('button');
    btnAll.className = 'cat all-cat active'; // actif par d√©faut
    btnAll.type = 'button';
    btnAll.textContent = 'Toutes les annonces';
    btnAll.setAttribute('aria-pressed', 'true');
    btnAll.dataset.cat = '';
    btnAll.addEventListener('click', ()=> {
      setCategoryValue('', btnAll);
      btnAll.setAttribute('aria-pressed', 'true');
    });
    categoriesList.appendChild(btnAll);

    // --- Cr√©ation des boutons de cat√©gories
    categories.forEach(cat=>{
      const btn = document.createElement('button');
      btn.className = 'cat';
      btn.type = 'button';
      btn.textContent = cat;
      btn.dataset.cat = cat;
      // accessible
      btn.setAttribute('aria-pressed', 'false');
      btn.addEventListener('click', ()=>{
        // d√©sactiver aria-pressed sur "Toutes"
        btnAll.setAttribute('aria-pressed', 'false');
        setCategoryValue(cat, btn);
        btn.setAttribute('aria-pressed', 'true');
      });
      categoriesList.appendChild(btn);

      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });

    // Si on change la s√©lection via le <select>, mettre √† jour les boutons visuels
    categorySelect.addEventListener('change', (e)=>{
      const chosen = e.target.value;
      // mettre aria et classes correctement
      if (!chosen) {
        setCategoryValue('', btnAll);
        btnAll.setAttribute('aria-pressed', 'true');
      } else {
        const matching = categoriesList.querySelector(`.cat[data-cat="${chosen}"]`);
        setCategoryValue(chosen, matching);
        if (matching) matching.setAttribute('aria-pressed', 'true');
        btnAll.setAttribute('aria-pressed', 'false');
      }
    });

    // Fonctions d'affichage
    const listingsEl = document.getElementById('listings');
    const countEl = document.getElementById('count');


    function createCard(a){
      const div = document.createElement('article'); div.className = 'card';
      div.innerHTML = `
        <img src="${a.image}" alt="${escapeHtml(a.title)}" loading="lazy" />
        <div class="card-body">
          <div class="badges"><span class="badge">${escapeHtml(a.category)}</span><span class="badge">${escapeHtml(a.location)}</span></div>
          <div class="title">${escapeHtml(a.title)}</div>
          <div class="meta"><a class="price">Par ${a.by}</a></div><div style="font-size:12px;color:var(--muted)">${a.date}</div></div>
        </div>
      `;
      div.addEventListener('click', ()=>showDetail(a, true));
      return div;
    }

    function escapeHtml(text){
      return (text||'').replace(/[&<>"]+/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    }

    function showDetail(a, redirect = false){
      if (redirect) {
       window.open("info.html", "_blank");
      }
    }

    function render(){
      const q = (document.getElementById('q').value||'').trim().toLowerCase();
      const cat = document.getElementById('categorySelect').value;
      const sort = document.getElementById('sort').value;

      let filtered = annonces.filter(a=>{
        const matchesQ = q === '' || a.title.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q) || a.location.toLowerCase().includes(q);
        const matchesCat = !cat || a.category === cat;
        return matchesQ && matchesCat;
      });

      filtered.sort((x,y)=> new Date(y.date) - new Date(x.date));

      listingsEl.innerHTML = '';
      if(filtered.length === 0){
        listingsEl.innerHTML = '<div style="padding:24px;background:white;border-radius:12px;box-shadow:var(--shadow)">Aucune annonce trouv√©e.</div>';
      } else {
        filtered.forEach(a=>listingsEl.appendChild(createCard(a)));
      }
      countEl.textContent = `${filtered.length} annonce${filtered.length>1?'s':''}`;
    }

    // Events
    document.getElementById('searchBtn').addEventListener('click', render);
    document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') render(); });
    document.getElementById('sort').addEventListener('change', render);

        // Render initial
        render();


        // ==========================
        // üó∫Ô∏è Initialisation de la carte
        // ==========================
        const map = L.map('map').setView([46.6, 2.4], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Marqueurs √† partir des annonces
        annonces.forEach(a => {
          // v√©rification minimale sur lat/lon
          if (!a.lat || !a.lon) return;
          const marker = L.marker([a.lat, a.lon]).addTo(map);

          marker.on('click', () => {
            // Popup affich√©e
            const popupContent = `
              <strong>${escapeHtml(a.title)} (${escapeHtml(a.location)})</strong><br>
              <br>
              ${a.desc}
              <br>
              <a href="info.html?id=${a.id}">En savoir plus</a>
            `;
            marker.bindPopup(popupContent).openPopup();

            // Option : d√©clenche le d√©tail d'annonce
            showDetail(a);
          });
        });

      } catch (err) {
        console.error("Erreur pendant le chargement des annonces :", err);
        // message d'erreur √† l'utilisateur
        const listingsEl = document.getElementById('listings');
        if (listingsEl) listingsEl.innerHTML = '<div style="padding:24px;background:white;border-radius:12px;box-shadow:var(--shadow)">Erreur lors du chargement des annonces.</div>';
      } finally {
        // on retire le loader dans tous les cas
        hideMapLoader();
      }
    }

    chargement();
  </script>

  <script>

  </script>
</body>
</html>
